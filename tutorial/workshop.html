

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Workshop &mdash; Seq 0.9.11 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Cookbook" href="../cookbook.html" />
    <link rel="prev" title="Tutorial" href="tutorial.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #333131" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> Seq
          

          
            
            <img src="../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.9
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro.html">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../intro.html#install">Install</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../intro.html#pre-built-binaries">Pre-built binaries</a></li>
<li class="toctree-l3"><a class="reference internal" href="../intro.html#building-from-source">Building from source</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../intro.html#usage">Usage</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="setup.html">Set-up</a><ul>
<li class="toctree-l3"><a class="reference internal" href="setup.html#installation">Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="setup.html#usage">Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="setup.html#creating-a-stand-alone-executable">Creating a stand-alone executable</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="primer.html">Language Primer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="primer.html#comments">Comments</a></li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#literals">Literals</a><ul>
<li class="toctree-l4"><a class="reference internal" href="primer.html#tuples">Tuples</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#containers">Containers</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#assignments-and-operators">Assignments and operators</a><ul>
<li class="toctree-l4"><a class="reference internal" href="primer.html#tuple-unpacking">Tuple unpacking</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#control-flow">Control flow</a><ul>
<li class="toctree-l4"><a class="reference internal" href="primer.html#conditionals">Conditionals</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#loops">Loops</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#comprehensions">Comprehensions</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#exception-handling">Exception handling</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#variables-and-scoping">Variables and scoping</a></li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#imports">Imports</a></li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#functions">Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="primer.html#generics">Generics</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#generators">Generators</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#pipes">Pipes</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#foreign-function-interface-ffi">Foreign function interface (FFI)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#classes-and-types">Classes and types</a><ul>
<li class="toctree-l4"><a class="reference internal" href="primer.html#type-extensions">Type extensions</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#magic-methods">Magic methods</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html">Tutorial</a><ul>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#limitations-and-key-differences-with-python">Limitations and key differences with Python</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#types">Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#genomics-specific-features">Genomics-specific features</a><ul>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#genomic-types">Genomic types</a></li>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#sequence-matching">Sequence matching</a></li>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#pipelines">Pipelines</a></li>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#sequence-alignment">Sequence alignment</a></li>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#genomic-index-prefetching">Genomic index prefetching</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#other-features">Other features</a><ul>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#parallelism">Parallelism</a></li>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#type-extensions">Type extensions</a></li>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#other-types">Other types</a></li>
<li class="toctree-l4"><a class="reference internal" href="tutorial.html#c-c-and-python-interoperability">C/C++ and Python interoperability</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#calling-bwa-from-seq">Calling BWA from Seq</a></li>
</ul>
</li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Workshop</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#code-listings">Code Listings</a></li>
<li class="toctree-l3"><a class="reference internal" href="#getting-started">Getting Started</a></li>
<li class="toctree-l3"><a class="reference internal" href="#section-1-reading-sequences-from-disk">Section 1: Reading sequences from disk</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#full-code-listing">Full code listing</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#section-2-building-an-index">Section 2: Building an index</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#section2-code">Full code listing</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#section-3-finding-k-mer-matches">Section 3: Finding k-mer matches</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#section3-code">Full code listing</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#section-4-smith-waterman-alignment-and-cigar-strings">Section 4: Smith-Waterman alignment and CIGAR strings</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#section4-code">Full code listing</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#section-5-pipelines">Section 5: Pipelines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#optional-parallelism">(Optional) Parallelism</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section5-code">Full code listing</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#section-6-domain-specific-optimizations">Section 6: Domain-specific optimizations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#section6-code">Full code listing</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../cookbook.html">Cookbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../cookbook.html#subsequence-extraction">Subsequence extraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cookbook.html#k-mer-extraction">k-mer extraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cookbook.html#reverse-complementation">Reverse complementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cookbook.html#k-mer-hamming-distance">k-mer Hamming distance</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cookbook.html#k-mer-hamming-neighbors">k-mer Hamming neighbors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cookbook.html#k-mer-minimizer">k-mer minimizer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cookbook.html#de-bruijn-edge">de Bruijn edge</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cookbook.html#count-bases">Count bases</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cookbook.html#spaced-seed-search">Spaced seed search</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cookbook.html#reverse-complement-palindrome">Reverse-complement palindrome</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cookbook.html#sequence-alignment">Sequence alignment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cookbook.html#reading-fasta-fastq">Reading FASTA/FASTQ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cookbook.html#reading-paired-end-fastq">Reading paired-end FASTQ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cookbook.html#parallel-fastq-processing">Parallel FASTQ processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cookbook.html#reading-sam-bam-cram">Reading SAM/BAM/CRAM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cookbook.html#dna-to-protein-translation">DNA to protein translation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cookbook.html#reading-protein-sequences-from-fasta">Reading protein sequences from FASTA</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../python.html">Calling Python from Seq</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../python.html#pyimport"><code class="docutils literal notranslate"><span class="pre">pyimport</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../python.html#pydef"><code class="docutils literal notranslate"><span class="pre">pydef</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../embed.html">Calling Seq from C/C++</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../embed.html#converting-types">Converting types</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../build.html">Building from Source</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../build.html#dependencies">Dependencies</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../build.html#platform-independent-notes">Platform-independent notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../build.html#macos">macOS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../build.html#ubuntu-debian">Ubuntu/Debian</a></li>
<li class="toctree-l3"><a class="reference internal" href="../build.html#centos-rhel">CentOS/RHEL</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../build.html#opam-setup">OPAM setup</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../build.html#building">Building</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../build.html#documentation">Documentation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../stdlib/index.html">Standard Library Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../stdlib/algorithms/index.html">algorithms</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/algorithms/heapsort.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">algorithms.heapsort</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/algorithms/insertionsort.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">algorithms.insertionsort</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/algorithms/pdqsort.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">algorithms.pdqsort</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/algorithms/qsort.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">algorithms.qsort</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/algorithms/strings.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">algorithms.strings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/algorithms/timsort.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">algorithms.timsort</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../stdlib/bio/index.html">bio</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/bio/align.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">bio.align</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/bio/bam.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">bio.bam</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/bio/bed.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">bio.bed</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/bio/block.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">bio.block</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/bio/builtin.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">bio.builtin</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/bio/bwa.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">bio.bwa</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/bio/bwt.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">bio.bwt</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/bio/c_htslib.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">bio.c_htslib</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/bio/fai.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">bio.fai</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/bio/fasta.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">bio.fasta</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/bio/fastq.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">bio.fastq</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/bio/fmindex.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">bio.fmindex</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/bio/intervals.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">bio.intervals</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/bio/iter.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">bio.iter</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/bio/locus.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">bio.locus</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/bio/pseq.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">bio.pseq</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/bio/seq.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">bio.seq</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/bio/vcf.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">bio.vcf</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../stdlib/bisect.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">bisect</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../stdlib/collections.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">collections</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../stdlib/core/index.html">core</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/core/aliases.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">core.aliases</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/core/box.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">core.box</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/core/builtin.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">core.builtin</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/core/c_stubs.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">core.c_stubs</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/core/collections/index.html">core.collections</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../stdlib/core/collections/dict.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">core.collections.dict</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../stdlib/core/collections/khash.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">core.collections.khash</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../stdlib/core/collections/list.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">core.collections.list</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../stdlib/core/collections/set.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">core.collections.set</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/core/dlopen.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">core.dlopen</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/core/err.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">core.err</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/core/file.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">core.file</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/core/float.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">core.float</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/core/gc.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">core.gc</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/core/int.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">core.int</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/core/optional.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">core.optional</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/core/python.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">core.python</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/core/range.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">core.range</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/core/slice.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">core.slice</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/core/sort.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">core.sort</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/core/str.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">core.str</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../stdlib/getopt.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">getopt</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../stdlib/gzip.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">gzip</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../stdlib/heapq.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">heapq</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../stdlib/itertools.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">itertools</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../stdlib/math.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">math</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../stdlib/os/index.html">os</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../stdlib/os/path.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">os.path</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../stdlib/pickle.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">pickle</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../stdlib/python.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">python</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../stdlib/random.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">random</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../stdlib/sortedlist.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">sortedlist</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../stdlib/statistics.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">statistics</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../stdlib/string.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">string</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../stdlib/sys.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">sys</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../stdlib/threading.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">threading</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../stdlib/time.html"><code class="xref seq seq-mod docutils literal notranslate"><span class="pre">time</span></code></a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Seq</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Tutorial</a> &raquo;</li>
        
      <li>Workshop</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/tutorial/workshop.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="workshop">
<h1>Workshop<a class="headerlink" href="#workshop" title="Permalink to this headline">¶</a></h1>
<p>In this workshop, we will build a toy read mapper called <em>SeqMap</em> to
showcase some of Seq’s domain-specific features and optimizations.</p>
<div class="section" id="code-listings">
<h2>Code Listings<a class="headerlink" href="#code-listings" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><strong>Section 1</strong>: <a class="reference internal" href="#section1-code"><span class="std std-ref">Full code listing</span></a> ｜ <a class="reference download internal" download="" href="../_downloads/11621a621d9806c75ae217367da61ffa/section1.seq"><code class="xref download docutils literal notranslate"><span class="pre">click</span> <span class="pre">to</span> <span class="pre">download</span></code></a></p></li>
<li><p><strong>Section 2</strong>: <a class="reference internal" href="#section2-code"><span class="std std-ref">Full code listing</span></a> ｜ <a class="reference download internal" download="" href="../_downloads/3119b8f33c02eef8b43e3a9a0f309cfd/section2.seq"><code class="xref download docutils literal notranslate"><span class="pre">click</span> <span class="pre">to</span> <span class="pre">download</span></code></a></p></li>
<li><p><strong>Section 3</strong>: <a class="reference internal" href="#section3-code"><span class="std std-ref">Full code listing</span></a> ｜ <a class="reference download internal" download="" href="../_downloads/7e395e106ebaf3a9cc14c314d6f5faf9/section3.seq"><code class="xref download docutils literal notranslate"><span class="pre">click</span> <span class="pre">to</span> <span class="pre">download</span></code></a></p></li>
<li><p><strong>Section 4</strong>: <a class="reference internal" href="#section4-code"><span class="std std-ref">Full code listing</span></a> ｜ <a class="reference download internal" download="" href="../_downloads/ebacb909ffb70f1d8a4fdbd85c317c62/section4.seq"><code class="xref download docutils literal notranslate"><span class="pre">click</span> <span class="pre">to</span> <span class="pre">download</span></code></a></p></li>
<li><p><strong>Section 5</strong>: <a class="reference internal" href="#section5-code"><span class="std std-ref">Full code listing</span></a> ｜ <a class="reference download internal" download="" href="../_downloads/927bef2d744033c861104b138887c2ca/section5.seq"><code class="xref download docutils literal notranslate"><span class="pre">click</span> <span class="pre">to</span> <span class="pre">download</span></code></a></p></li>
<li><p><strong>Section 6</strong>: <a class="reference internal" href="#section6-code"><span class="std std-ref">Full code listing</span></a> ｜ <a class="reference download internal" download="" href="../_downloads/f0dce7da1786b8db0cc3a53c573f35c8/section6.seq"><code class="xref download docutils literal notranslate"><span class="pre">click</span> <span class="pre">to</span> <span class="pre">download</span></code></a></p></li>
</ul>
</div>
<div class="section" id="getting-started">
<h2>Getting Started<a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h2>
<p>If you don’t have Seq installed already, you can install it with one bash command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>/bin/bash -c <span class="s2">&quot;</span><span class="k">$(</span>curl -fsSL https://seq-lang.org/install.sh<span class="k">)</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>Be sure to restart the shell for <code class="docutils literal notranslate"><span class="pre">seqc</span></code> to be added to your <code class="docutils literal notranslate"><span class="pre">PATH</span></code> (or add it manually).</p>
<p>Now, let’s create a new directory to house our Seq code and test data:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir seqmap
<span class="nb">cd</span> seqmap
</pre></div>
</div>
<p>We’ll test <em>SeqMap</em> on the following data:</p>
<ul class="simple">
<li><p>Chromosome 22 as the reference sequence (<code class="docutils literal notranslate"><span class="pre">chr22.fa</span></code>, 52MB)</p></li>
<li><p>A simulated set of 1 million 101bp reads (<code class="docutils literal notranslate"><span class="pre">reads.fastq</span></code>, 251MB)</p></li>
</ul>
<p>Let’s download this data into a new folder called <code class="docutils literal notranslate"><span class="pre">data</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl -L http://seq.csail.mit.edu/data.tar.gz <span class="p">|</span> tar zxf - -C .
</pre></div>
</div>
<p>What does this data actually look like? Let’s take a look:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>head data/reads.fq
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>@chr22_16993648_16994131_1:0:0_2:0:0_0/1
CTACCAAACACCTACTTCGTTTCCTAACATCACTTTAATTTTATCTTAGAGGAATTCTTTTCCCTATCCCATTAAGTTATGGGAGATGGGGCCAGGCATGG
+
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
@chr22_28253010_28253558_1:0:0_0:0:0_1/1
AGTGTTTTGCCTGTGGCTAGACTAAAAATAAGGAATGAGGGGGGTATCTTCCACTCTTGCCCTCTCATCACCCTATTCCCTATATCCAGAACTCAGAGTCC
+
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
@chr22_21656192_21656802_0:0:0_2:0:0_2/1
ATAGCGTGGATTCCTATGACATCAAGGAGCTATTTTATTTGGTAAAACGAAAAAGCACAATAATGAACGAACGCAAGCACTGAAACAGTGGAGACACCTAG
</pre></div>
</div>
<p>Each <a class="reference external" href="https://en.wikipedia.org/wiki/FASTQ_format">FASTQ</a> record consists of four lines:</p>
<ul class="simple">
<li><p>Read name, starting with <code class="docutils literal notranslate"><span class="pre">&#64;</span></code>. Notice that since this data is simulated, the read name includes the
location on the genome where the read comes from; this will be useful later!</p></li>
<li><p>Read sequence. This is a DNA sequence consisting of <code class="docutils literal notranslate"><span class="pre">ACGT</span></code> bases and possibly <code class="docutils literal notranslate"><span class="pre">N</span></code>, indicating an
ambiguous base.</p></li>
<li><p>Separator (<code class="docutils literal notranslate"><span class="pre">+</span></code>)</p></li>
<li><p>Read quality scores. This is a string of characters as long as the read sequence, where each character
indicates the “quality” of the corresponding base in the read sequence. We won’t be using it here.</p></li>
</ul>
<p>What about the reference sequence <a class="reference external" href="https://en.wikipedia.org/wiki/FASTA_format">FASTA</a> file?</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>head data/chr22.fa
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt;chr22
NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN
</pre></div>
</div>
<p>FASTQ records start with the sequence name (prefixed with <code class="docutils literal notranslate"><span class="pre">&gt;</span></code>) followed by the sequence itself, split
across multiple lines. But why are all the bases <code class="docutils literal notranslate"><span class="pre">N</span></code>? Chromosomal sequences often have their starts
and ends masked with <code class="docutils literal notranslate"><span class="pre">N</span></code>’s to cover repetitive <a class="reference external" href="https://en.wikipedia.org/wiki/Telomere">telomeric</a> sequences.
Since we usually don’t want to include such regions in our analyses, they are masked in the file. Let’s
look a bit further down:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>head -n <span class="m">1000000</span> data/chr22.fa <span class="p">|</span> tail -n <span class="m">10</span>
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>tattaaaggaaaaaactgtatgaaatagtacatttctcataattctcatt
ttgtaaaaataaagtacttatctatggacataatgagaaaatgactcaag
gtaccaagagtttagccattagctataccagtggattataagcaaattct
gttACGTGCATGCACTCACCTACGCATGTTCATGTATTCATACATACGTA
CATAATTTTTTAAATTTTCTTTTATAGACAAGCAATAGCTTTATAATCTC
TATAATCAGTAAAAATAAGTAAGTggctggacgcagtggctcacacctgt
aatctcagcactttgggaggctgaggagggcagattatgaggtcagaaga
tcaagaccatcctggctaacacagtgaaaccccatctctactaaaaatac
aaaaaattagccacgcgtggtggcacgcgcctgtagtcccagctactggg
gaggctgaggcaggaaaatcgcttgaacccgggaggcagaggttgcggtg
</pre></div>
</div>
<p>Now we can see the usual <code class="docutils literal notranslate"><span class="pre">ACGT</span></code> bases. The fact that some bases are lowercase indicates that they
are a part of some repetitive element or region. Seq will handle these different uppercase and lowercase
characters automatically, so we don’t need to worry about them.</p>
<p>You might notice an additional file called <code class="docutils literal notranslate"><span class="pre">chr22.fa.fai</span></code>: this is a FASTA index file that includes
information about each sequence contained in the file for easier parsing. We won’t use it directly,
but Seq uses it internally to make FASTA parsing more efficient.</p>
</div>
<div class="section" id="section-1-reading-sequences-from-disk">
<h2>Section 1: Reading sequences from disk<a class="headerlink" href="#section-1-reading-sequences-from-disk" title="Permalink to this headline">¶</a></h2>
<p>The first step of processing any kind of sequencing data is to read it from disk.
Seq has builtin support for many of the standard file formats such as FASTA, FASTQ,
SAM, BAM, etc.</p>
<p>Let’s write a program to read our FASTQ file and print each record’s name and sequence
on a single line:</p>
<div class="highlight-seq notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sys</span> <span class="k">import</span> <span class="n">argv</span>
<span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">FASTQ</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="k">print</span> <span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">seq</span>
</pre></div>
</div>
<p>Now we can run this Seq program:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>seqc section1.seq data/reads.fq &gt; out.txt
</pre></div>
</div>
<p>and view the results:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>head out.txt
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>chr22_16993648_16994131_1:0:0_2:0:0_0/1 CTACCAAACACCTACTTCGTTTCCTAACATCACTTTAATTTTATCTTAGAGGAATTCTTTTCCCTATCCCATTAAGTTATGGGAGATGGGGCCAGGCATGG
chr22_28253010_28253558_1:0:0_0:0:0_1/1 AGTGTTTTGCCTGTGGCTAGACTAAAAATAAGGAATGAGGGGGGTATCTTCCACTCTTGCCCTCTCATCACCCTATTCCCTATATCCAGAACTCAGAGTCC
chr22_21656192_21656802_0:0:0_2:0:0_2/1 ATAGCGTGGATTCCTATGACATCAAGGAGCTATTTTATTTGGTAAAACGAAAAAGCACAATAATGAACGAACGCAAGCACTGAAACAGTGGAGACACCTAG
chr22_44541236_44541725_0:1:0_0:0:0_3/1 CTCTCTGTCTCTCTCTCTCCCCTAGGTCAGGGTGGTCCCTGGGGAGGCCCCTGGGTTACCCCAAGACAGGTGGGAGGTGCTTCCTACCCGACCCTCTTCCT
chr22_39607671_39608139_0:0:0_2:0:0_4/1 ATTGGCTCAGAGTTCAGCAGGCTGTACCAGCATGGCGCCAGTGTCTGCTCCTGGTGAGGCCTTACGGACGTTACAATAACGGCGGAAGGCAAAGGCGGAGC
chr22_35577703_35578255_3:0:0_1:0:0_5/1 TGCCATGGTGGTTAGCTGCACCCATCAACCTGTCATCTACATTAGGTATTTTTCCTAATGCTATCCCTCCCCTAGCACCCTACCCTCTGATAGGCCCTGGT
chr22_46059124_46059578_1:0:0_1:0:0_6/1 AATCAGTACCAAACAATATATGGATATTATTGGCACTTTGTGCTCCCTCTGCCTGAACTGGGAATTCCTCTATTAGTTTTGACATTATCTGGTATTGAACC
chr22_31651867_31652385_2:0:0_2:0:0_7/1 ATCTAGTGACAGTAAGTGGCTGATAAAGTGAGCTGCCATTACATAGTCATCATCTTTAATAGAAGTTAACACATACTGAGTTTCTACTATATTGGGTCTTT
chr22_24816466_24817026_1:0:0_1:0:0_8/1 CACCTCTAGGGCTCAAGGGGCAGTTCCTCCATTCCTCAGCAGTGGCGCCTGTGGAACTGTGTCCTGAGGCCAGGGGGTGGTCAGGCAGGGCCTGGAGTGGC
chr22_27496272_27496752_1:0:0_1:0:0_9/1 CTTAGCCCCATTAAACACTGGCAGGGCTGAATTGTCTGCTGCCATCCATCACACCTTCTCCCCTAGCCTGGTTTCTTACCTACCTGGAAGCCGTCCCTTTT
</pre></div>
</div>
<p>Pretty straightforward! FASTA files can be read in a very similar way.</p>
<div class="section" id="full-code-listing">
<span id="section1-code"></span><h3>Full code listing<a class="headerlink" href="#full-code-listing" title="Permalink to this headline">¶</a></h3>
<p><a class="reference download internal" download="" href="../_downloads/11621a621d9806c75ae217367da61ffa/section1.seq"><code class="xref download docutils literal notranslate"><span class="pre">click</span> <span class="pre">to</span> <span class="pre">download</span></code></a></p>
<div class="highlight-seq notranslate"><div class="highlight"><pre><span></span><span class="c1"># SeqMap</span>
<span class="c1"># Seq workshop -- Section 1</span>
<span class="c1"># Reads and prints a FASTQ file.</span>
<span class="c1"># Usage: seqc section1.seq &lt;FASTQ path&gt;</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="k">import</span> <span class="n">argv</span>
<span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">FASTQ</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="k">print</span> <span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">seq</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section-2-building-an-index">
<h2>Section 2: Building an index<a class="headerlink" href="#section-2-building-an-index" title="Permalink to this headline">¶</a></h2>
<p>Our goal is to find a “mapping” on the genome for each read. Comparing to every
position on the reference sequence would take far too long. An alternative is
to create an index of the k-mers from the reference sequence and use it to guide
the mapping process.</p>
<p>Let’s build a dictionary that maps each k-mer to its position (“locus”) on the
reference sequence:</p>
<div class="highlight-seq notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sys</span> <span class="k">import</span> <span class="n">argv</span>
<span class="k">type</span> <span class="n">K</span> <span class="o">=</span> <span class="nb">Kmer</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span>
<span class="n">index</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="n">K</span><span class="p">,</span><span class="nb">int</span><span class="p">]()</span>

<span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">FASTA</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span><span class="n">kmer</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">seq</span><span class="o">.</span><span class="n">kmers_with_pos</span><span class="p">[</span><span class="n">K</span><span class="p">](</span><span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">index</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span>
</pre></div>
</div>
<p>Of course, there will be k-mers that appear multiple times, but let’s ignore this
detail for now and just store the latest position we see for each k-mer.</p>
<p>Another important issue is <em>reverse complementation</em>: some of our reads will map
in the reverse direction rather than in the forward direction. For this reason,
let’s build our index in such a way that a k-mer is considered “equal” to its
reverse complement. One easy way to do this is by using “canonical” k-mers, i.e.
the minimum of a k-mer and its reverse complement:</p>
<div class="highlight-seq notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sys</span> <span class="k">import</span> <span class="n">argv</span>
<span class="k">type</span> <span class="n">K</span> <span class="o">=</span> <span class="nb">Kmer</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span>
<span class="n">index</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="n">K</span><span class="p">,</span><span class="nb">int</span><span class="p">]()</span>

<span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">FASTA</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span><span class="n">kmer</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">seq</span><span class="o">.</span><span class="n">kmers_with_pos</span><span class="p">[</span><span class="n">K</span><span class="p">](</span><span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">index</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">kmer</span><span class="p">,</span> <span class="o">~</span><span class="n">kmer</span><span class="p">)]</span> <span class="o">=</span> <span class="n">pos</span>  <span class="c1"># &lt;--</span>
</pre></div>
</div>
<p>(We’ll have to use canonical k-mers when querying the index too, of course.)</p>
<p>Now we have our index as a dictionary (<code class="docutils literal notranslate"><span class="pre">index</span></code>), but we don’t want to build it
each time we perform read mapping, since it only depends on the (fixed) reference
sequence. So, as a last step, let’s dump the index to a file using the <code class="docutils literal notranslate"><span class="pre">pickle</span></code>
module:</p>
<div class="highlight-seq notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">gzip</span>

<span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.index&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">jar</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">jar</span><span class="p">)</span>
</pre></div>
</div>
<p>Run the program:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>seqc section2.seq data/chr22.fa
</pre></div>
</div>
<p>Now we should see a new file <code class="docutils literal notranslate"><span class="pre">data/chr22.fa.index</span></code> which stores our
serialized index.</p>
<p>The nice thing is we should only have to build our index once!</p>
<div class="section" id="section2-code">
<span id="id1"></span><h3>Full code listing<a class="headerlink" href="#section2-code" title="Permalink to this headline">¶</a></h3>
<p><a class="reference download internal" download="" href="../_downloads/3119b8f33c02eef8b43e3a9a0f309cfd/section2.seq"><code class="xref download docutils literal notranslate"><span class="pre">click</span> <span class="pre">to</span> <span class="pre">download</span></code></a></p>
<div class="highlight-seq notranslate"><div class="highlight"><pre><span></span><span class="c1"># SeqMap</span>
<span class="c1"># Seq workshop -- Section 2</span>
<span class="c1"># Reads and constructs a hash table index from an input</span>
<span class="c1"># FASTA file.</span>
<span class="c1"># Usage: seqc section2.seq &lt;FASTA path&gt;</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="k">import</span> <span class="n">argv</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">gzip</span>

<span class="k">type</span> <span class="n">K</span> <span class="o">=</span> <span class="nb">Kmer</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span>
<span class="n">index</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="n">K</span><span class="p">,</span><span class="nb">int</span><span class="p">]()</span>

<span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">FASTA</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span><span class="n">kmer</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">seq</span><span class="o">.</span><span class="n">kmers_with_pos</span><span class="p">[</span><span class="n">K</span><span class="p">](</span><span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">index</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">kmer</span><span class="p">,</span> <span class="o">~</span><span class="n">kmer</span><span class="p">)]</span> <span class="o">=</span> <span class="n">pos</span>

<span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.index&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">jar</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">jar</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section-3-finding-k-mer-matches">
<h2>Section 3: Finding k-mer matches<a class="headerlink" href="#section-3-finding-k-mer-matches" title="Permalink to this headline">¶</a></h2>
<p>At this point, we have an index we can load from disk. Let’s use it
to find candidate mappings for our reads.</p>
<p>We’ll split each read into k-mers and report a mapping if at least two
k-mers support a particular locus.</p>
<p>The first step is to load the index:</p>
<div class="highlight-seq notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sys</span> <span class="k">import</span> <span class="n">argv</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">gzip</span>

<span class="k">type</span> <span class="n">K</span> <span class="o">=</span> <span class="nb">Kmer</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span>
<span class="n">index</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">K</span><span class="p">,</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.index&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">jar</span><span class="p">:</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="n">K</span><span class="p">,</span><span class="nb">int</span><span class="p">]](</span><span class="n">jar</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we can iterate over our reads and query k-mers in the index. We need
a way to keep track of candidate mapping positions as we process the
k-mers of a read: we can do this using a new dictionary, <code class="docutils literal notranslate"><span class="pre">candidates</span></code>,
which maps candidate alignment positions to the number of k-mers supporting
the given position.</p>
<p>Then, we just iterate over <code class="docutils literal notranslate"><span class="pre">candidates</span></code> and output positions supported by
2 or more k-mers. Finally, we clear <code class="docutils literal notranslate"><span class="pre">candidates</span></code> before processing the next
read:</p>
<div class="highlight-seq notranslate"><div class="highlight"><pre><span></span><span class="n">candidates</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]()</span>  <span class="c1"># position -&gt; count mapping</span>
<span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">FASTQ</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span><span class="n">kmer</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">kmers_with_pos</span><span class="p">[</span><span class="n">K</span><span class="p">](</span><span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">kmer</span><span class="p">,</span> <span class="o">~</span><span class="n">kmer</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">found</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">candidates</span><span class="o">.</span><span class="n">increment</span><span class="p">(</span><span class="n">found</span> <span class="o">-</span> <span class="n">pos</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span><span class="n">count</span> <span class="ow">in</span> <span class="n">candidates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">candidates</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</pre></div>
</div>
<p>Run the program:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>seqc section3.seq data/chr22.fa data/reads.fq &gt; out.txt
</pre></div>
</div>
<p>Let’s take a look at the output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>head out.txt
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>chr22_16993648_16994131_1:0:0_2:0:0_0/1 16993648
chr22_28253010_28253558_1:0:0_0:0:0_1/1 28253010
chr22_44541236_44541725_0:1:0_0:0:0_3/1 44541236
chr22_31651867_31652385_2:0:0_2:0:0_7/1 31651867
chr22_21584577_21585142_1:0:0_1:0:0_a/1 21584577
chr22_46629499_46629977_0:0:0_2:0:0_b/1 47088563
chr22_46629499_46629977_0:0:0_2:0:0_b/1 51103174
chr22_46629499_46629977_0:0:0_2:0:0_b/1 46795988
chr22_16269615_16270134_0:0:0_1:0:0_c/1 50577316
chr22_16269615_16270134_0:0:0_1:0:0_c/1 16269615
</pre></div>
</div>
<p>Notice that most positions we reported match the position from the read
name (the first integer after the <code class="docutils literal notranslate"><span class="pre">_</span></code>); not bad!</p>
<div class="section" id="section3-code">
<span id="id2"></span><h3>Full code listing<a class="headerlink" href="#section3-code" title="Permalink to this headline">¶</a></h3>
<p><a class="reference download internal" download="" href="../_downloads/7e395e106ebaf3a9cc14c314d6f5faf9/section3.seq"><code class="xref download docutils literal notranslate"><span class="pre">click</span> <span class="pre">to</span> <span class="pre">download</span></code></a></p>
<div class="highlight-seq notranslate"><div class="highlight"><pre><span></span><span class="c1"># SeqMap</span>
<span class="c1"># Seq workshop -- Section 3</span>
<span class="c1"># Reads index constructed in Section 2 and looks up k-mers from</span>
<span class="c1"># input reads to find candidate mappings.</span>
<span class="c1"># Usage: seqc section3.seq &lt;FASTA path&gt; &lt;FASTQ path&gt;</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="k">import</span> <span class="n">argv</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">gzip</span>

<span class="k">type</span> <span class="n">K</span> <span class="o">=</span> <span class="nb">Kmer</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span>
<span class="n">index</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">K</span><span class="p">,</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.index&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">jar</span><span class="p">:</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="n">K</span><span class="p">,</span><span class="nb">int</span><span class="p">]](</span><span class="n">jar</span><span class="p">)</span>

<span class="n">candidates</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]()</span>  <span class="c1"># position -&gt; count mapping</span>
<span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">FASTQ</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span><span class="n">kmer</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">kmers_with_pos</span><span class="p">[</span><span class="n">K</span><span class="p">](</span><span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">kmer</span><span class="p">,</span> <span class="o">~</span><span class="n">kmer</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">found</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">candidates</span><span class="o">.</span><span class="n">increment</span><span class="p">(</span><span class="n">found</span> <span class="o">-</span> <span class="n">pos</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span><span class="n">count</span> <span class="ow">in</span> <span class="n">candidates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">candidates</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section-4-smith-waterman-alignment-and-cigar-strings">
<h2>Section 4: Smith-Waterman alignment and CIGAR strings<a class="headerlink" href="#section-4-smith-waterman-alignment-and-cigar-strings" title="Permalink to this headline">¶</a></h2>
<p>We now have the ability to report mapping <em>positions</em> for each read,
but usually we want <em>alignments</em>, which include information about
mismatches, insertions and deletions.</p>
<p>Luckily, Seq makes sequence alignment easy: to align sequence <code class="docutils literal notranslate"><span class="pre">q</span></code>
against sequence <code class="docutils literal notranslate"><span class="pre">t</span></code>, you can just do:</p>
<div class="highlight-seq notranslate"><div class="highlight"><pre><span></span><span class="n">aln</span> <span class="o">=</span> <span class="n">q</span> <span class="o">@</span> <span class="n">t</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">aln</span></code> is a tuple of alignment score and CIGAR string (a <em>CIGAR string</em> is
a way of encoding an alignment result, and consists of operations such as <code class="docutils literal notranslate"><span class="pre">M</span></code>
for match/mismatch, <code class="docutils literal notranslate"><span class="pre">I</span></code> for insertion and <code class="docutils literal notranslate"><span class="pre">D</span></code> for deletion, accompanied
by the number of associated bases; for example, <code class="docutils literal notranslate"><span class="pre">3M2I4M</span></code> indicates 3 (mis)matches
followed by a length-2 insertion followed by 4 (mis)matches).</p>
<p>By default, <a class="reference external" href="https://en.wikipedia.org/wiki/Levenshtein_distance">Levenshtein distance</a> is
used, meaning mismatch and gap costs are both 1, while match costs are zero. More
control over alignment parameters can be achieved using the <code class="docutils literal notranslate"><span class="pre">align</span></code> method:</p>
<div class="highlight-seq notranslate"><div class="highlight"><pre><span></span><span class="n">aln</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ambig</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">gapo</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">gape</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">a</span></code> is the match score, <code class="docutils literal notranslate"><span class="pre">b</span></code> is the mismatch cost, <code class="docutils literal notranslate"><span class="pre">ambig</span></code> is the
ambiguous base (<code class="docutils literal notranslate"><span class="pre">N</span></code>) match score, <code class="docutils literal notranslate"><span class="pre">gapo</span></code> is the gap open cost and <code class="docutils literal notranslate"><span class="pre">gape</span></code>
the gap extension cost (i.e. a gap of length <code class="docutils literal notranslate"><span class="pre">k</span></code> costs <code class="docutils literal notranslate"><span class="pre">gapo</span> <span class="pre">+</span> <span class="pre">(k</span> <span class="pre">*</span> <span class="pre">gape)</span></code>).
There are many more parameters as well, controlling factors like alignment bandwidth,
Z-drop, global/extension alignment and more; check the
<a class="reference external" href="https://docs.seq-lang.org/stdlib/bio/align.html#bio.align.seq.align">standard library reference</a>
for further details.</p>
<p>For now, we’ll use a simple <code class="docutils literal notranslate"><span class="pre">query.align(target)</span></code>:</p>
<div class="highlight-seq notranslate"><div class="highlight"><pre><span></span><span class="n">candidates</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]()</span>
<span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">FASTQ</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span><span class="n">kmer</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">kmers_with_pos</span><span class="p">[</span><span class="n">K</span><span class="p">](</span><span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">kmer</span><span class="p">,</span> <span class="o">~</span><span class="n">kmer</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">found</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">candidates</span><span class="o">.</span><span class="n">increment</span><span class="p">(</span><span class="n">found</span> <span class="o">-</span> <span class="n">pos</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span><span class="n">count</span> <span class="ow">in</span> <span class="n">candidates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># get query, target and align:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">read</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">reference</span><span class="p">[</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">)]</span>
            <span class="n">alignment</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
            <span class="k">print</span> <span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">alignment</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="n">alignment</span><span class="o">.</span><span class="n">cigar</span>

    <span class="n">candidates</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</pre></div>
</div>
<p>Run the program:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>seqc section4.seq data/chr22.fa data/reads.fq &gt; out.txt
</pre></div>
</div>
<p>And let’s take a look at the output once again:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>head out.txt
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>chr22_16993648_16994131_1:0:0_2:0:0_0/1 16993648 196 101M
chr22_28253010_28253558_1:0:0_0:0:0_1/1 28253010 196 101M
chr22_44541236_44541725_0:1:0_0:0:0_3/1 44541236 196 101M
chr22_31651867_31652385_2:0:0_2:0:0_7/1 31651867 190 101M
chr22_21584577_21585142_1:0:0_1:0:0_a/1 21584577 196 101M
chr22_46629499_46629977_0:0:0_2:0:0_b/1 47088563 110 20M1I4M1D76M
chr22_46629499_46629977_0:0:0_2:0:0_b/1 51103174 134 20M1I4M1D76M
chr22_46629499_46629977_0:0:0_2:0:0_b/1 46795988 128 20M1I4M1D76M
chr22_16269615_16270134_0:0:0_1:0:0_c/1 50577316 118 101M
chr22_16269615_16270134_0:0:0_1:0:0_c/1 16269615 202 101M
</pre></div>
</div>
<p>Most of the alignments contain only matches or mismatches (<code class="docutils literal notranslate"><span class="pre">M</span></code>), which
is to be expected as insertions and deletions are far less common. In fact,
the three mappings containing indels appear to be incorrect!</p>
<p>A more thorough mapping scheme would also look at alignment scores before
reporting mappings, although for the purposes of this workshop we’ll ignore
such improvements.</p>
<div class="section" id="section4-code">
<span id="id3"></span><h3>Full code listing<a class="headerlink" href="#section4-code" title="Permalink to this headline">¶</a></h3>
<p><a class="reference download internal" download="" href="../_downloads/ebacb909ffb70f1d8a4fdbd85c317c62/section4.seq"><code class="xref download docutils literal notranslate"><span class="pre">click</span> <span class="pre">to</span> <span class="pre">download</span></code></a></p>
<div class="highlight-seq notranslate"><div class="highlight"><pre><span></span><span class="c1"># SeqMap</span>
<span class="c1"># Seq workshop -- Section 4</span>
<span class="c1"># Reads index constructed in Section 2 and looks up k-mers from</span>
<span class="c1"># input reads to find candidate mappings, then performs alignment.</span>
<span class="c1"># Usage: seqc section4.seq &lt;FASTA path&gt; &lt;FASTQ path&gt;</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="k">import</span> <span class="n">argv</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">gzip</span>

<span class="k">type</span> <span class="n">K</span> <span class="o">=</span> <span class="nb">Kmer</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span>
<span class="n">index</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">K</span><span class="p">,</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">reference</span> <span class="o">=</span> <span class="sa">s</span><span class="s1">&#39;&#39;</span>
<span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">FASTA</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">seq</span>

<span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.index&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">jar</span><span class="p">:</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="n">K</span><span class="p">,</span><span class="nb">int</span><span class="p">]](</span><span class="n">jar</span><span class="p">)</span>

<span class="n">candidates</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]()</span>
<span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">FASTQ</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span><span class="n">kmer</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">kmers_with_pos</span><span class="p">[</span><span class="n">K</span><span class="p">](</span><span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">kmer</span><span class="p">,</span> <span class="o">~</span><span class="n">kmer</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">found</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">candidates</span><span class="o">.</span><span class="n">increment</span><span class="p">(</span><span class="n">found</span> <span class="o">-</span> <span class="n">pos</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span><span class="n">count</span> <span class="ow">in</span> <span class="n">candidates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">read</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">reference</span><span class="p">[</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">)]</span>
            <span class="n">alignment</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
            <span class="k">print</span> <span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">alignment</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="n">alignment</span><span class="o">.</span><span class="n">cigar</span>

    <span class="n">candidates</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section-5-pipelines">
<h2>Section 5: Pipelines<a class="headerlink" href="#section-5-pipelines" title="Permalink to this headline">¶</a></h2>
<p>Pipelines are a very convenient Seq construct for expressing a variety
of algorithms and applications. In fact, <em>SeqMap</em> can be thought of as
a pipeline with the following stages:</p>
<ul class="simple">
<li><p>read a record from the FASTQ file,</p></li>
<li><p>find candidate alignments by querying the index,</p></li>
<li><p>perform alignment for mappings supported by 2+ k-mers and output results.</p></li>
</ul>
<p>We can write this as a pipeline in Seq as follows:</p>
<div class="highlight-seq notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">find_candidates</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
    <span class="n">candidates</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]()</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span><span class="n">kmer</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">kmers_with_pos</span><span class="p">[</span><span class="n">K</span><span class="p">](</span><span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">kmer</span><span class="p">,</span> <span class="o">~</span><span class="n">kmer</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">found</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">candidates</span><span class="o">.</span><span class="n">increment</span><span class="p">(</span><span class="n">found</span> <span class="o">-</span> <span class="n">pos</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span><span class="n">count</span> <span class="ow">in</span> <span class="n">candidates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">record</span><span class="p">,</span> <span class="n">pos</span>

<span class="k">def</span> <span class="nf">align_and_output</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="n">record</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">t</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">read</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">reference</span><span class="p">[</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">)]</span>
    <span class="n">alignment</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">alignment</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="n">alignment</span><span class="o">.</span><span class="n">cigar</span>
</pre></div>
</div>
<p>Notice that <code class="docutils literal notranslate"><span class="pre">find_candidates</span></code> <em>yields</em> candidate alignments to <code class="docutils literal notranslate"><span class="pre">align_and_output</span></code>,
which then performs alignment and prints the results. In Seq, all values generated
from one stage of a pipeline are passed to the next. The Seq compiler performs many
domain-specific optimizations on pipelines, one of which we focus on in the next section.</p>
<div class="section" id="optional-parallelism">
<h3>(Optional) Parallelism<a class="headerlink" href="#optional-parallelism" title="Permalink to this headline">¶</a></h3>
<p>Parallelism can be achieved using the parallel pipe operator, <code class="docutils literal notranslate"><span class="pre">||&gt;</span></code>, which
tells the compiler that all subsequent stages can be executed in parallel:</p>
<div class="highlight-seq notranslate"><div class="highlight"><pre><span></span><span class="n">FASTQ</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">|&gt;</span> <span class="nb">iter</span> <span class="o">||&gt;</span> <span class="n">find_candidates</span> <span class="o">|&gt;</span> <span class="n">align_and_output</span>
</pre></div>
</div>
<p>Since the full program also involves loading the index, let’s time the main
pipeline using the <code class="docutils literal notranslate"><span class="pre">timing</span></code> module:</p>
<div class="highlight-seq notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">timing</span>
<span class="k">with</span> <span class="n">timing</span><span class="p">(</span><span class="s1">&#39;mapping&#39;</span><span class="p">):</span>
    <span class="n">FASTQ</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">|&gt;</span> <span class="nb">iter</span> <span class="o">||&gt;</span> <span class="n">find_candidates</span> <span class="o">|&gt;</span> <span class="n">align_and_output</span>
</pre></div>
</div>
<p>We can try this for different numbers of threads:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">1</span>
seqc section5.seq data/chr22.fa data/reads.fq &gt; out.txt
<span class="c1"># mapping took 48.2858s</span>

<span class="nb">export</span> <span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">2</span>
seqc section5.seq data/chr22.fa data/reads.fq &gt; out.txt
<span class="c1"># mapping took 35.886s</span>
</pre></div>
</div>
<p>Often, batching reads into larger blocks and processing those blocks in parallel can
yield better performance, especially if each read is quick to process. This is also
very easy to do in Seq:</p>
<div class="highlight-seq notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_block</span><span class="p">(</span><span class="n">block</span><span class="p">):</span>
    <span class="n">block</span> <span class="o">|&gt;</span> <span class="nb">iter</span> <span class="o">|&gt;</span> <span class="n">find_candidates</span> <span class="o">|&gt;</span> <span class="n">align_and_output</span>

<span class="k">with</span> <span class="n">timing</span><span class="p">(</span><span class="s1">&#39;mapping&#39;</span><span class="p">):</span>
    <span class="n">FASTQ</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">|&gt;</span> <span class="n">blocks</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span> <span class="o">||&gt;</span> <span class="n">process_block</span>
</pre></div>
</div>
<p>And now:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">1</span>
seqc section5.seq data/chr22.fa data/reads.fq &gt; out.txt
<span class="c1"># mapping took 48.2858s</span>

<span class="nb">export</span> <span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">2</span>
seqc section5.seq data/chr22.fa data/reads.fq &gt; out.txt
<span class="c1"># mapping took 25.2648s</span>
</pre></div>
</div>
</div>
<div class="section" id="section5-code">
<span id="id4"></span><h3>Full code listing<a class="headerlink" href="#section5-code" title="Permalink to this headline">¶</a></h3>
<p><a class="reference download internal" download="" href="../_downloads/927bef2d744033c861104b138887c2ca/section5.seq"><code class="xref download docutils literal notranslate"><span class="pre">click</span> <span class="pre">to</span> <span class="pre">download</span></code></a></p>
<div class="highlight-seq notranslate"><div class="highlight"><pre><span></span><span class="c1"># SeqMap</span>
<span class="c1"># Seq workshop -- Section 5</span>
<span class="c1"># Reads index constructed in Section 2 and looks up k-mers from</span>
<span class="c1"># input reads to find candidate mappings, then performs alignment.</span>
<span class="c1"># Implemented with Seq pipelines.</span>
<span class="c1"># Usage: seqc section5.seq &lt;FASTA path&gt; &lt;FASTQ path&gt;</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="k">import</span> <span class="n">argv</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">timing</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">gzip</span>

<span class="k">type</span> <span class="n">K</span> <span class="o">=</span> <span class="nb">Kmer</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span>
<span class="n">index</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">K</span><span class="p">,</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">reference</span> <span class="o">=</span> <span class="sa">s</span><span class="s1">&#39;&#39;</span>
<span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">FASTA</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">seq</span>

<span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.index&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">jar</span><span class="p">:</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="n">K</span><span class="p">,</span><span class="nb">int</span><span class="p">]](</span><span class="n">jar</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">find_candidates</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
    <span class="n">candidates</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]()</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span><span class="n">kmer</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">kmers_with_pos</span><span class="p">[</span><span class="n">K</span><span class="p">](</span><span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">kmer</span><span class="p">,</span> <span class="o">~</span><span class="n">kmer</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">found</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">candidates</span><span class="o">.</span><span class="n">increment</span><span class="p">(</span><span class="n">found</span> <span class="o">-</span> <span class="n">pos</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span><span class="n">count</span> <span class="ow">in</span> <span class="n">candidates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">record</span><span class="p">,</span> <span class="n">pos</span>

<span class="k">def</span> <span class="nf">align_and_output</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="n">record</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">t</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">read</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">reference</span><span class="p">[</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">)]</span>
    <span class="n">alignment</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">alignment</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="n">alignment</span><span class="o">.</span><span class="n">cigar</span>

<span class="k">with</span> <span class="n">timing</span><span class="p">(</span><span class="s1">&#39;mapping&#39;</span><span class="p">):</span>
    <span class="n">FASTQ</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">|&gt;</span> <span class="nb">iter</span> <span class="o">|&gt;</span> <span class="n">find_candidates</span> <span class="o">|&gt;</span> <span class="n">align_and_output</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section-6-domain-specific-optimizations">
<h2>Section 6: Domain-specific optimizations<a class="headerlink" href="#section-6-domain-specific-optimizations" title="Permalink to this headline">¶</a></h2>
<p>Seq already performs numerous domain-specific optimizations under the hood.
However, we can give the compiler a hint in this case to perform one more:
<em>inter-sequence alignment</em>. This optimization entails batching sequences
prior to alignment, then aligning multiple pairs using a very fast SIMD
optimized alignment kernel.</p>
<p>In Seq, we just need one additional function annotation to tell the compiler
to perform this optimization:</p>
<div class="highlight-seq notranslate"><div class="highlight"><pre><span></span><span class="nd">@inter_align</span>
<span class="k">def</span> <span class="nf">align_and_output</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Let’s run the program with and without this optimization:</p>
<div class="highlight-seq notranslate"><div class="highlight"><pre><span></span><span class="c1"># without @inter_align</span>
<span class="n">seqc</span> <span class="n">section5</span><span class="o">.</span><span class="n">seq</span> <span class="n">data</span><span class="o">/</span><span class="n">chr22</span><span class="o">.</span><span class="n">fa</span> <span class="n">data</span><span class="o">/</span><span class="n">reads</span><span class="o">.</span><span class="n">fq</span> <span class="o">&gt;</span> <span class="n">out</span><span class="o">.</span><span class="n">txt</span>
<span class="c1"># mapping took 43.4457s</span>

<span class="c1"># with @inter_align</span>
<span class="n">seqc</span> <span class="n">section6</span><span class="o">.</span><span class="n">seq</span> <span class="n">data</span><span class="o">/</span><span class="n">chr22</span><span class="o">.</span><span class="n">fa</span> <span class="n">data</span><span class="o">/</span><span class="n">reads</span><span class="o">.</span><span class="n">fq</span> <span class="o">&gt;</span> <span class="n">out</span><span class="o">.</span><span class="n">txt</span>
<span class="c1"># mapping took 32.3241s</span>
</pre></div>
</div>
<p>(The timings with inter-sequence alignment will depend on the SIMD instruction
sets your CPU supports; these numbers are from using AVX2.)</p>
<div class="section" id="section6-code">
<span id="id5"></span><h3>Full code listing<a class="headerlink" href="#section6-code" title="Permalink to this headline">¶</a></h3>
<p><a class="reference download internal" download="" href="../_downloads/f0dce7da1786b8db0cc3a53c573f35c8/section6.seq"><code class="xref download docutils literal notranslate"><span class="pre">click</span> <span class="pre">to</span> <span class="pre">download</span></code></a></p>
<div class="highlight-seq notranslate"><div class="highlight"><pre><span></span><span class="c1"># SeqMap</span>
<span class="c1"># Seq workshop -- Section 6</span>
<span class="c1"># Reads index constructed in Section 2 and looks up k-mers from</span>
<span class="c1"># input reads to find candidate mappings, then performs alignment.</span>
<span class="c1"># Implemented with Seq pipelines using inter-seq. alignment.</span>
<span class="c1"># Usage: seqc section6.seq &lt;FASTA path&gt; &lt;FASTQ path&gt;</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="k">import</span> <span class="n">argv</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">timing</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">gzip</span>

<span class="k">type</span> <span class="n">K</span> <span class="o">=</span> <span class="nb">Kmer</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span>
<span class="n">index</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">K</span><span class="p">,</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">reference</span> <span class="o">=</span> <span class="sa">s</span><span class="s1">&#39;&#39;</span>
<span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">FASTA</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">seq</span>

<span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.index&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">jar</span><span class="p">:</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="n">K</span><span class="p">,</span><span class="nb">int</span><span class="p">]](</span><span class="n">jar</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">find_candidates</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
    <span class="n">candidates</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]()</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span><span class="n">kmer</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">kmers_with_pos</span><span class="p">[</span><span class="n">K</span><span class="p">](</span><span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">kmer</span><span class="p">,</span> <span class="o">~</span><span class="n">kmer</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">found</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">candidates</span><span class="o">.</span><span class="n">increment</span><span class="p">(</span><span class="n">found</span> <span class="o">-</span> <span class="n">pos</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span><span class="n">count</span> <span class="ow">in</span> <span class="n">candidates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">record</span><span class="p">,</span> <span class="n">pos</span>

<span class="nd">@inter_align</span>
<span class="k">def</span> <span class="nf">align_and_output</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="n">record</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">t</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">read</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">reference</span><span class="p">[</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">)]</span>
    <span class="n">alignment</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">alignment</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="n">alignment</span><span class="o">.</span><span class="n">cigar</span>

<span class="k">with</span> <span class="n">timing</span><span class="p">(</span><span class="s1">&#39;mapping&#39;</span><span class="p">):</span>
    <span class="n">FASTQ</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">|&gt;</span> <span class="nb">iter</span> <span class="o">|&gt;</span> <span class="n">find_candidates</span> <span class="o">|&gt;</span> <span class="n">align_and_output</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../cookbook.html" class="btn btn-neutral float-right" title="Cookbook" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="tutorial.html" class="btn btn-neutral float-left" title="Tutorial" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2019, seq-lang

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>